<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Создание коллажа</title>
    <style>
        body {
            font-family: 'Unbounded', sans-serif;
            color: #145569;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            color: #145569;
            font-size: 24px;
            white-space: nowrap;
        }
        .settings {
            margin-bottom: 20px;
        }
        .grid-selector, .size-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .grid-option, .size-option {
            padding: 8px;
            border: 2px solid #ccc;
            cursor: pointer;
            text-align: center;
            border-radius: 5px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 70px;
            height: 70px;
        }
        /* Отдельные стили для блоков сеток */
        .grid-option {
            width: 70px;
            height: 70px;
            font-size: 14px;
        }
        /* Отдельные стили для блоков размеров */
        .size-option {
            width: 30px;
            height: 30px;
            font-size: 12px;
        }
        .grid-option.selected, .size-option.selected {
            border-color: #1583A3;
            background-color: #1583A3;
            color: white;
        }
        .grid-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .grid-icon svg {
            width: 50px;
            height: 50px;
            fill: none;
            stroke: #1583A3;
            stroke-width: 1.5;
            stroke-linejoin: round;
            box-sizing: border-box;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #1583A3;
        }
        .file-list {
            margin-bottom: 20px;
        }
        .file-item {
            padding: 5px;
            background-color: #eee;
            margin: 5px 0;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .create-button {
            width: 65%;
            padding: 15px;
            background-color: #1583A3;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin: 0 auto;
            display: block;
        }
        .create-button:hover {
            background-color: #126a80;
        }
        .progress {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        /* Стили для результата */
        .result-container {
            display: none;
            margin-top: 20px;
        }
        .result-message {
            background-color: #e8f7fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .collage-grid {
            display: grid;
            gap: 5px;
            margin-bottom: 20px;
        }
        .collage-item {
            width: 100%;
            height: auto;
            border-radius: 5px;
            overflow: hidden;
        }
        .collage-item img, .collage-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .download-button {
            width: 65%;
            padding: 15px;
            background-color: #1583A3;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin: 0 auto;
            display: block;
        }
        .download-button:hover {
            background-color: #126a80;
        }
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-top: -5px;
        }
        .action-button {
            width: 65%;
            padding: 15px;
            background-color: #1583A3;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin: 0 auto;
            display: block;
        }
        .action-button:hover {
            background-color: #126a80;
        }
        .step-container {
            display: none;
        }
        .active {
            display: block;
        }
        .error-message {
            color: #e53e3e;
            text-align: center;
            padding: 15px;
            background-color: #fed7d7;
            border-radius: 5px;
            margin: 15px 0;
        }
        .file-count {
            text-align: center;
            font-weight: bold;
            color: #2d3748;
            margin: 10px 0;
        }
        .collage-preview {
            width: 100%;
            /*aspect-ratio: 9/16; */
            border: 1px solid #ddd;
            overflow: hidden;
            margin-top: 20px;
            position: relative;
            background-color: #000;
        }
        .video-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .grid-preview {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        .grid-cell {
            width: 40px;
            height: 40px;
            border: 1px solid #ccc;
            background-color: #eee;
        }
        .grid-cell.video {
            background-color: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        .grid-cell.photo {
            background-color: #4ade80;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        /* Стили для изображений сетки */
        .grid-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            background-color: transparent;
        }
        .instructions {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .step-container {
            margin-bottom: 20px;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .step-header {
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .step-header h3 {
            margin: 0;
            color: #145569;
        }
        /* Добавленные стили для кнопок с двумя строками расстояния */
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 1em; /* Два пробела между кнопками */
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Создание коллажа</h1>
        </div>
        <div class="settings">
            <h3>Выберите сетку:</h3>
            <div class="grid-selector">
                <!-- Первая строка -->
                <div class="grid-option" data-grid="2x2">
                    <div class="grid-icon">
                        <svg viewBox="0 0 24 24">
                            <rect x="1" y="1" width="10" height="10" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="13" y="1" width="10" height="10" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="1" y="13" width="10" height="10" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="13" y="13" width="10" height="10" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                        </svg>
                    </div>
                </div>
                <div class="grid-option" data-grid="2x3">
                    <div class="grid-icon">
                        <svg viewBox="0 0 24 24">
                            <rect x="1" y="1" width="10" height="6" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="13" y="1" width="10" height="6" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="1" y="9" width="10" height="6" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="13" y="9" width="10" height="6" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="1" y="17" width="10" height="6" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="13" y="17" width="10" height="6" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                        </svg>
                    </div>
                </div>
                <div class="grid-option" data-grid="3x1">
                    <div class="grid-icon">
                        <svg viewBox="0 0 25 25">
                            <rect x="1" y="1" width="6.5" height="22" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="9" y="1" width="6.5" height="22" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="17" y="1" width="6.5" height="22" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                        </svg>
                    </div>
                </div>
                <!-- Вторая строка -->
                <div class="grid-option" data-grid="1x3">
                    <div class="grid-icon">
                        <svg viewBox="0 0 24 24">
                            <rect x="1" y="1" width="22" height="6" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="1" y="9" width="22" height="6" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="1" y="17" width="22" height="6" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                        </svg>
                    </div>
                </div>
                <div class="grid-option" data-grid="2x1">
                    <div class="grid-icon">
                        <svg viewBox="0 0 24 24">
                            <rect x="1" y="1" width="10" height="22" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="13" y="1" width="10" height="22" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                        </svg>
                    </div>
                </div>
                <div class="grid-option" data-grid="1x2">
                    <div class="grid-icon">
                        <svg viewBox="0 0 24 24">
                            <rect x="1" y="1" width="22" height="10" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                            <rect x="1" y="13" width="22" height="10" rx="1" ry="1" stroke-width="1" fill="none" stroke="currentColor"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <div class="settings">
            <h3>Выберите размер:</h3>
            <div class="size-selector">
                <div class="size-option" data-size="9:16">9:16</div>
                <div class="size-option" data-size="3:4">3:4</div>
                <div class="size-option" data-size="1:1">1:1</div>
                <div class="size-option" data-size="4:3">4:3</div>
                <div class="size-option" data-size="16:9">16:9</div>
            </div>
        </div>
        <div class="upload-area" id="uploadArea">
            <p>Загрузите фото и/или видео:</p>
            <p id="fileCount">загружено 0/4 файлов</p>
        </div>
        <div class="file-list" id="fileList"></div>
        <button class="create-button" id="createCollageBtn" style="display:none;">СОЗДАТЬ КОЛЛАЖ</button>
        <div class="error-message" id="errorMessage" style="display:none;"></div>
        <div id="loading" class="loading" style="display:none;">
            <p>Создаем коллаж, скоро всё будет!</p>
        </div>
        <!-- Результат -->
        <div id="step4" class="step-container">
            <div class="instructions">
                <p><strong>Коллаж создан!</strong></p>
            </div>
            <div class="collage-preview" id="collagePreview"><!-- Здесь будет отображаться коллаж --></div>
            <div class="button-container">
                <button class="action-button" onclick="downloadCollage()">Скачать коллаж</button>
                <button class="action-button" onclick="newCollage()">Новый коллаж</button>
            </div>
        </div>
    </div>
    <script>
        // Переменные для хранения данных (без значений по умолчанию)
        let selectedGrid = null; // Будет null до выбора пользователем
        let selectedSize = null; // Будет null до выбора пользователем
        let uploadedFiles = [];
        let requiredCount = 0; // Будет 0 до выбора сетки
        let originalFiles = []; // Для сохранения оригинальных файлов при изменении размера
        let collageUrl = ''; // Для хранения URL коллажа

        // Функция получения параметров из URL
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                grid: urlParams.get('grid'),
                size: urlParams.get('size'),
                media: urlParams.get('media')
            };
        }

        // Функция обновления соотношения сторон предпросмотра
        function updatePreviewAspectRatio(size) {
            const preview = document.getElementById('collagePreview');
            switch (size) {
                case "9:16":
                    preview.style.aspectRatio = "9 / 16";
                    break;
                case "16:9":
                    preview.style.aspectRatio = "16 / 9";
                    break;
                case "1:1":
                    preview.style.aspectRatio = "1 / 1";
                    break;
                case "3:4":
                    preview.style.aspectRatio = "3 / 4";
                    break;
                case "4:3":
                    preview.style.aspectRatio = "4 / 3";
                    break;
                default:
                    preview.style.aspectRatio = "1 / 1"; // На случай ошибки
            }
        }

        // Маппинг количества файлов для каждой сетки
        const gridFileCounts = {
            '2x2': 4,
            '2x3': 6,
            '3x1': 3,
            '1x3': 3,
            '2x1': 2,
            '1x2': 2
        };

        // Функция получения количества требуемых файлов
        function getRequiredCount(grid) {
            return gridFileCounts[grid] || 0; // Возвращает 0, если сетка не найдена
        }

        // Функция обновления счетчика файлов
        function updateFileCounter() {
            const fileCount = document.getElementById('fileCount');
            if (fileCount && selectedGrid) { // Только если сетка выбрана
                const maxFiles = getRequiredCount(selectedGrid);
                fileCount.textContent = `загружено ${uploadedFiles.length}/${maxFiles} файлов`;
            }
        }

        // Функция отображения ошибки
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        // Функция скрытия ошибки
        function hideError() {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        // Функция скачивания коллажа
        function downloadCollage() {
            if (collageUrl) {
                const link = document.createElement('a');
                link.href = collageUrl;
                link.download = 'collage.mp4';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Ссылка на скачивание недоступна.');
            }
        }

        // Функция начала нового коллажа
        function newCollage() {
            // Очищаем все данные
            uploadedFiles = [];
            originalFiles = [];
            collageUrl = '';

            // Сбрасываем выбор сетки и размера
            document.querySelectorAll('.grid-option').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.size-option').forEach(el => el.classList.remove('selected'));

            // Сбрасываем переменные
            selectedGrid = null;
            selectedSize = null;
            requiredCount = 0;

            // Скрываем результат и показываем первый шаг
            document.getElementById('step4').classList.remove('active');
            document.getElementById('step1').classList.add('active');

            // Очищаем предпросмотр
            document.getElementById('collagePreview').innerHTML = '';

            // Скрываем кнопку создания
            document.getElementById('createCollageBtn').style.display = 'none';

            // Очищаем ошибку
            hideError();

            // Показываем сообщение о необходимости выбора
            showError('Пожалуйста, выберите сетку и размер для создания коллажа.');
        }

        // Автоматическое заполнение полей при загрузке страницы
        window.addEventListener('load', function() {
            const params = getUrlParams();

            // Проверяем, есть ли параметры в URL
            if (params.grid || params.size) {
                console.log('Параметры из URL:', params);

                // Автоматически выбрать сетку, если параметр grid есть
                if (params.grid) {
                    const gridItems = document.querySelectorAll('.grid-option');
                    let foundGrid = false;

                    gridItems.forEach(item => {
                        if (item.dataset.grid === params.grid) {
                            item.click(); // Имитируем клик для выбора
                            foundGrid = true;
                        }
                    });

                    // Если сетка не найдена, ничего не выбираем (остается null)
                    if (!foundGrid) {
                        console.log('Сетка не найдена в URL');
                    }
                }

                // Автоматически выбрать размер, если параметр size есть
                if (params.size) {
                    const sizeItems = document.querySelectorAll('.size-option');
                    let foundSize = false;

                    sizeItems.forEach(item => {
                        if (item.dataset.size === params.size) {
                            item.click(); // Имитируем клик для выбора
                            foundSize = true;
                        }
                    });

                    // Если размер не найден, ничего не выбираем (остается null)
                    if (!foundSize) {
                        console.log('Размер не найден в URL');
                    }
                }
            }

            // Если ни сетка, ни размер не выбраны, показываем сообщение
            if (!selectedGrid || !selectedSize) {
                showError('Пожалуйста, выберите сетку и размер для создания коллажа.');
            }
        });

        // Обработчики для выбора сетки
        document.querySelectorAll('.grid-option').forEach(item => {
            item.addEventListener('click', () => {
                selectedGrid = item.dataset.grid;
                document.querySelectorAll('.grid-option').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
                requiredCount = getRequiredCount(selectedGrid);
                updateFileCounter();

                // Проверяем, выбраны ли и сетка, и размер
                checkCreateButtonState();
            });
        });

        // Обработчики для выбора размера
        document.querySelectorAll('.size-option').forEach(item => {
            item.addEventListener('click', () => {
                selectedSize = item.dataset.size;
                document.querySelectorAll('.size-option').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
                updatePreviewAspectRatio(selectedSize);

                // Проверяем, выбраны ли и сетка, и размер
                checkCreateButtonState();
            });
        });

        // Функция проверки состояния кнопки создания
        function checkCreateButtonState() {
            const createBtn = document.getElementById('createCollageBtn');
            if (createBtn) {
                // Кнопка активна только если выбраны и сетка, и размер, и достаточно файлов
                if (selectedGrid && selectedSize && uploadedFiles.length >= requiredCount) {
                    createBtn.style.display = 'block';
                    createBtn.disabled = false;
                } else {
                    createBtn.style.display = 'none';
                }
            }
        }

        // Обработчик загрузки файлов
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
            uploadArea.addEventListener('click', function() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.multiple = true;
                fileInput.accept = 'image/*,video/*';
                fileInput.onchange = function(e) {
                    const files = Array.from(e.target.files);

                    // Проверяем, что сетка выбрана
                    if (!selectedGrid) {
                        showError('Пожалуйста, сначала выберите сетку для коллажа.');
                        return;
                    }

                    // Проверяем, не превышено ли максимальное количество файлов
                    const maxFiles = requiredCount * 2; // Максимум в 2 раза больше требуемого
                    if (files.length > maxFiles) {
                        showError(`Вы загрузили слишком много файлов (${files.length}). Максимум ${maxFiles} файлов.`);
                        document.getElementById('createCollageBtn').style.display = 'none';
                        return;
                    }

                    // Очищаем ошибку
                    hideError();

                    // Обновляем список файлов
                    uploadedFiles = files;
                    originalFiles = [...uploadedFiles]; // Сохраняем оригинальные файлы

                    // Обновляем счетчик
                    const currentCountElement = document.getElementById('currentCount');
                    if (currentCountElement) {
                        currentCountElement.textContent = uploadedFiles.length;
                    }

                    // Обновляем текст в загрузочной области
                    document.getElementById('fileCount').textContent = `загружено ${uploadedFiles.length}/${requiredCount} файлов`;

                    // Проверяем состояние кнопки создания
                    checkCreateButtonState();
                };
                fileInput.click();
            });
        }

        // Обработчик создания коллажа
        document.getElementById('createCollageBtn').addEventListener('click', function() {
            // Проверяем, что сетка и размер выбраны
            if (!selectedGrid || !selectedSize) {
                showError('Пожалуйста, выберите сетку и размер для создания коллажа.');
                return;
            }

            // Проверяем количество файлов
            if (uploadedFiles.length > requiredCount) {
                showError(`Упс, вы загрузили слишком много файлов (${uploadedFiles.length}). Пожалуйста, загрузите не более ${requiredCount} файлов.`);
                return;
            }
            if (uploadedFiles.length >= requiredCount) {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('createCollageBtn').disabled = true;
                // Отправляем данные на сервер
                fetch("https://ashva-collage.loca.lt/create-collage", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        grid: selectedGrid,
                        size: selectedSize,
                        media: uploadedFiles.map(f => ({
                            url: URL.createObjectURL(f),
                            type: f.type.startsWith("video/") ? "video" : "photo"
                        }))
                    })
                })
                .then(res => {
                    console.log("Отправляем данные:", { grid: selectedGrid, size: selectedSize, files: uploadedFiles.length });
                    return res.json();
                })
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('createCollageBtn').disabled = false;
                    if (data.status === "success") {
                        collageUrl = data.url;
                        // Отправляем результат обратно в бота
                        if (window.Telegram && Telegram.WebApp) {
                            Telegram.WebApp.sendData(JSON.stringify({
                                type: "collage_result",
                                url: collageUrl
                            }));
                        }
                        showStep(4);
                        displayCollage();
                    } else {
                        showError("Ошибка при создании коллажа: " + data.message);
                    }
                })
                .catch(err => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('createCollageBtn').disabled = false;
                    showError("Ошибка соединения с сервером: " + err.message);
                });
            }
        });

        // Функция отправки в бот
        function sendToBot() {
            alert('Файл будет отправлен в бот. Пожалуйста, используйте кнопку "Отправить в бот" в Telegram.');
            // Для тестирования можно просто открыть ссылку
            // window.open('https://t.me/ваш_бот_username?start=collage_' + Date.now(), '_blank');
        }

        // Функция для перехода между шагами
        function showStep(stepNumber) {
            // Скрыть все шаги
            document.querySelectorAll('.step-container').forEach(step => {
                step.classList.remove('active');
            });

            // Показать нужный шаг
            document.getElementById('step' + stepNumber).classList.add('active');
        }

        // Функция отображения коллажа (упрощенная)
        function displayCollage() {
            const preview = document.getElementById('collagePreview');
            preview.innerHTML = '';

            // Проверяем, что у нас есть файлы
            if (!uploadedFiles || uploadedFiles.length === 0) {
                preview.innerHTML = '<p style="text-align:center; color:red;">Нет файлов для отображения</p>';
                return;
            }
            // Устанавливаем количество столбцов и строк в зависимости от сетки
            if (selectedGrid === "2x2") {
                const cols = 2, rows = 2;
                const cellWidth = 100 / cols;
                const cellHeight = 100 / rows;
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const idx = r * cols + c;
                        if (idx < uploadedFiles.length) {
                            const file = uploadedFiles[idx];
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src = URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src = URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        } else {
                            // Пустая ячейка (черная)
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.backgroundColor = '#000';
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            preview.appendChild(div);
                        }
                    }
                }
            } else if (selectedGrid === "2x3") {
                const cols = 2, rows = 3;
                const cellWidth = 100 / cols;
                const cellHeight = 100 / rows;
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const idx = r * cols + c;
                        if (idx < uploadedFiles.length) {
                            const file = uploadedFiles[idx];
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src = URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src = URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        } else {
                            // Пустая ячейка (черная)
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.backgroundColor = '#000';
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            preview.appendChild(div);
                        }
                    }
                }
            } else if (selectedGrid === "3x1") {
                const cols = 1, rows = 3;
                const cellWidth = 100 / cols;
                const cellHeight = 100 / rows;
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const idx = r * cols + c;
                        if (idx < uploadedFiles.length) {
                            const file = uploadedFiles[idx];
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src = URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src = URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        } else {
                            // Пустая ячейка (черная)
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.backgroundColor = '#000';
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            preview.appendChild(div);
                        }
                    }
                }
            } else if (selectedGrid === "1x3") {
                const cols = 3, rows = 1;
                const cellWidth = 100 / cols;
                const cellHeight = 100 / rows;
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const idx = r * cols + c;
                        if (idx < uploadedFiles.length) {
                            const file = uploadedFiles[idx];
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src = URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src = URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        } else {
                            // Пустая ячейка (черная)
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.backgroundColor = '#000';
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            preview.appendChild(div);
                        }
                    }
                }
            } else if (selectedGrid === "2x1") {
                const cols = 1, rows = 2;
                const cellWidth = 100 / cols;
                const cellHeight = 100 / rows;
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const idx = r * cols + c;
                        if (idx < uploadedFiles.length) {
                            const file = uploadedFiles[idx];
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src = URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src = URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        } else {
                            // Пустая ячейка (черная)
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.backgroundColor = '#000';
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            preview.appendChild(div);
                        }
                    }
                }
            } else if (selectedGrid === "1x2") {
                const cols = 2, rows = 1;
                const cellWidth = 100 / cols;
                const cellHeight = 100 / rows;
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const idx = r * cols + c;
                        if (idx < uploadedFiles.length) {
                            const file = uploadedFiles[idx];
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src = URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src = URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        } else {
                            // Пустая ячейка (черная)
                            const div = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height = `${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.backgroundColor = '#000';
                            div.style.border = '1px solid rgba(255,255,255,0.3)';
                            preview.appendChild(div);
                        }
                    }
                }
            }
            const cellWidth = 100 / cols;
            const cellHeight = 100 / rows;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const idx = r * cols + c;
                    if (idx < uploadedFiles.length) {
                        const file = uploadedFiles[idx];
                        const url = URL.createObjectURL(file);
                        const type = file.type.startsWith('image') ? 'img' : 'video';
                        const element = document.createElement(type === 'img' ? 'img' : 'video');
                        element.src = url;
                        element.style.width = `${cellWidth}%`;
                        element.style.height = `${cellHeight}%`;
                        element.style.objectFit = 'cover';
                        element.style.position = 'absolute';
                        element.style.left = `${c * cellWidth}%`;
                        element.style.top = `${r * cellHeight}%`;
                        element.controls = type === 'video'; // Добавляем controls для видео
                        preview.appendChild(element);
                    } else {
                        // Добавляем пустой блок для заполнения
                        const emptyCell = document.createElement('div');
                        emptyCell.style.width = `${cellWidth}%`;
                        emptyCell.style.height = `${cellHeight}%`;
                        emptyCell.style.position = 'absolute';
                        emptyCell.style.left = `${c * cellWidth}%`;
                        emptyCell.style.top = `${r * cellHeight}%`;
                        emptyCell.style.backgroundColor = '#f0f0f0';
                        preview.appendChild(emptyCell);
                    }
                }
            }
        }
    </script>
</body>
</html>
